#  Автоматизация администрирования SQL Server
## Служба SQL Server Agent: назначение, автоматический запуск от имени доменной учетной записи, роль базы данных MSDB

Многие административные операции на сервере являются повторяющимися. 
Например, очень часто изо дня в день приходится производить:

- резервное копирование;
- проверку целостности баз данных;
- загрузку и выгрузку данных;
- перестроение индексов и дефрагментацию,

а также многие другие действия, набор которых зависит от конкретной задачи.

Кроме того, в некоторых ситуациях необходимо сделать так, 
чтобы администратор был немедленно извещен о каких-то важных событиях на сервере 
(например, внесены изменения в важные таблицы, выявлена ошибка при проверке целостности данных, возникли проблемы при массовой загрузке и т. п.).

И выполнение определенных действий по расписанию, и отслеживание событий рекомендуется автоматизировать. 
Чем более опытен и квалифицирован администратор, тем большее количество повседневных операций он старается автоматизировать, 
чтобы освободить свое время для других дел.

В этом модуле речь и пойдет про автоматизацию административных операций. 
Также будут рассмотрены средства, которые обеспечивают дополнительные функциональные возможности для автоматизации.

Отметим также, что часто для автоматизации административных операций удобно использовать скрипты 
VBScript или JavaScript (или программы на любом COM-совместимом языке, например Visual Basic, VBA, C++, Java, Delphi и другие, или .NET-совместимые программы), 
которые работают с объектными моделями SMO, SQL-DMO и WMI.

##  Автоматизация административных операций средствами SQL Server Agent
### Что такое SQL Server Agent
SQL Server Agent — это служба SQL Server, основное назначение которой — автоматизация выполнения административных операций. Сама автоматизация осуществляется при помощи:

- заданий (jobs) — именованных наборов действий, которые можно выполнять по расписанию;
- предупреждений (alerts) — действий, которые выполняются в ответ на событие, произошедшее на SQL Server. 
Таким действием может быть, например, выполнение задания или отправка сообщения оператору. 
События — это либо ошибки с определенным номером на SQL Server (их можно определять и генерировать самостоятельно), 
либо выход счетчика производительности за какие-то границы, либо специальные события WMI (т. е. ответ, пришедший на специальный событийный запрос на языке WQL);
- операторов (operators) — записей в адресной книге, на которые будут отправляться сообщения.

Отметим только общие моменты, которые связаны с SQL Server Agent.

Первое, что необходимо отметить — для использования автоматизации административных операций необходимо, 
чтобы служба SQL Server Agent работала. 
Будет ли она запускаться автоматически при запуске сервера или ее нужно будет запускать вручную, 
зависит от параметров, которые вы выбрали при установке сервера. 
Проверить, работает ли эта служба (и при необходимости запустить или изменить режим запуска), 
можно при помощи SQL Server Configuration Manager.

Второй момент — служебная информация SQL Server Agent (в том числе информация о заданиях, предупреждениях и операторах) 
хранится в специальной служебной базе данных msdb. 
Если вы активно работаете с заданиями и предупреждениями, 
не забывайте регулярно производить резервное копирование этой базы данных.

Третье, что нужно отменить, — возможности SQL Server Agent (и его работоспособность) зависят от того, от имени какой учетной записи работает эта служба. 
Рекомендуется, чтобы:

- SQL Server Agent работал от имени той же доменной учетной записи, от имени которой работает сам SQL Server;
- эта доменная учетная запись обладала бы на компьютере правами локального администратора.

Учетная запись, от имени которой работает SQL Server Agent, определяется при установке SQL Server 2005. 
Затем ее можно изменить, например, при помощи SQL Server Configuration Manager.
Возможностей настройки безопасности при работе SQL Server Agent в SQL Server 2005 очень много. 

И, в четвертых, для SQL Server Agent предусмотрена своя система журналов, 
при помощи которой можно получить информацию о всех происходящих с этой службой событиях. 
Просмотреть журналы можно из контейнера SQL Server Agent | Error Logs (Журналы ошибок) в SQL Server Management Studio.

Перед созданием заданий, оповещений и операторов рекомендуется проверить параметры SQL Server Agent: соответствуют ли они вашим потребностям.

## SQL Server Agent - свойства, автоматический перезапуск, настройка журналов, перенаправление событий

Параметры SQL Server Agent, как и большинства других объектов SQL Server 2005, можно изменить двумя способами:

- при помощи графического интерфейса SQL Server Management Studio. Для этого достаточно открыть свойства контейнера SQL Server Agent в Object Explorer;

- при помощи специальных хранимых процедур (например, sp_set_sqlagent_properties). Рассматривать эти хранимые процедуры мы не будем, поскольку команды на их применение можно очень просто сгенерировать при помощи кнопки Script (Скрипт) на экране свойств SQL Server Agent в Management Studio.

Далее приведен перечень параметров, которые можно настроить для SQL Server Agent с краткими комментариями. Вначале рассмотрим параметры на вкладке General (Общие) окна свойств SQL Server Agent:

- Auto restart SQL Server if it stops unexpectedly (Автоматически перезапускать SQL Server при неожиданной остановке) — SQL Server Agent будет контролировать работу службы SQL Server и при необходимости запускать сервер заново. Конечно, SQL Server без причины обычно не останавливается, поэтому значение этого параметра, в принципе, не очень важно. Тем не менее, такой контроль по умолчанию включен;

- Auto restart SQL Server Agent if it stops unexpectedly (Автоматически перезапускать SQL Server Agent при неожиданной остановке) — это обратный контроль. Данный параметр определяет, будет ли SQL Server контролировать работу службы SQL Server Agent и при необходимости производить перезапуск этой службы. По умолчанию параметр также включен;

- File name (Имя файла) в разделе Error Log (Журнал ошибок) — это путь к текстовому файлу протокола работы службы SQL Server Agent. Просмотреть этот протокол можно при помощи контейнера SQL Server Agent | Error Logs (Журнал ошибок) (или просто открыть файл в Блокноте);

- Include execution trace messages (Включить сообщения трассировки) — если этот флажок установлен, то в файл протокола будет также записываться трассировочная информация для процесса SQL Server Agent. Обычно эта возможность нужна только для отладки (при этом не выполнения заданий, а только самой службы SQL Server Agent). В журнал будет записываться большое количество дополнительной информации, которая администраторам обычно не нужна;

- Write OEM file (Записывать файл в формате OEM) — по умолчанию текстовый файл протокола создается в формате UNICODE. Если вам нужен файл в обычном текстовом формате (не UNICODE), можно установить этот флажок. Обычно он нужен только в одной ситуации: когда вы обрабатываете файл журнала какой-то специализированной программой, не понимающей кодировку UNICODE.

- Net send recipient (Получатель по net send) — имя компьютера (IP-адрес) или имя пользователя, которому будут автоматически передаваться по команде net send (при помощи окон сообщений) записи, регистрируемые в протоколе SQL Server Agent. Здесь нужно отметить два момента:

  -  служба Messenger (Служба сообщений), которая ответственна за работу с сообщениями, передаваемыми по net send, по умолчанию в Windows Server 2003 отключена. Чтобы получать сетевые сообщения, вам потребуется сначала включить эту службу;

  -  в журнал событий SQL Server Agent записывается большое количество сообщений, и всплывающие окна будут сильно мешать работе пользователя, на компьютер которого они отправляются. Поэтому имеет смысл определять получателя только в каких-то специальных ситуациях.

На вкладке Advanced (Дополнительно) вы можете настроить параметры перенаправления сообщений и условий, при которых центральный процессор будет считаться бездействующим:

- Forward events to a different server (Перенаправлять события на другой сервер) — этот параметр имеет смысл включать тогда, когда у вас на предприятии используются несколько серверов, и вы хотите упростить просмотр журналов, сконцентрировав все сообщения на одном сервере. По умолчанию, если на вашем компьютере установлено несколько экземпляров SQL Server, все сообщения будут передаваться на тот экземпляр, который был установлен первым;

- Events (События) — при помощи этой группы параметров вы можете определить, какие именно события будут перенаправляться для записи на другой сервер. В вашем распоряжении следующие параметры:

  -  Unhandled events (Неперехваченные события) — на другой SQL Server будут передаваться записи только о тех событиях, для которых не настроены предупреждения (про предупреждения будет рассказываться в разд. 8.1.7);

  -  All events (Все события) — будет передаваться информация о всех событиях;

  -  If event has severity at or above (Если у события важность находится на уровне или выше) — этот параметр позволяет настроить фильтр для передаваемых сообщений по их важности. По умолчанию используется самый низкий уровень 001, поэтому передаваться будут все сообщения;

- Define idle CPU condition (Определить условия простоя центрального процессора) — единственное назначение этого набора параметров — возможность определить для задания, что оно должно запуститься, когда процессоры компьютера, на котором установлен SQL Server, бездействуют (т. е. выполнены определенные при помощи этих параметров условия). На практике такие задания используются очень редко. Сами условия, при выполнении которых центральный процессор будет считаться бездействующим, можно определить при помощи следующих параметров:

  -  Average CPU usage falls below (Средняя загрузка центрального процессора падает ниже) — по умолчанию установлено 10%;

  -  And remains below this level for (И остается ниже этого уровня в течение) — по умолчанию задано 600 секунд, т. е. 10 минут.

На вкладке Alert system (Система предупреждений) вы можете определить общие параметры работы SQL Server Agent с предупреждениями. Обратите внимание, что вы не можете определить адреса тех, кому будут отправляться предупреждения, из свойств SQL Server Agent — для этого потребуется создать объекты операторов. На этой вкладке вы можете определить лишь общие настройки, которые будут применяться для всех предупреждений:

- Enable mail profile (Включить почтовый профиль) — если этот флажок установлен, то SQL Server Agent получает возможность взаимодействовать с электронной почтой (например, отправлять по электронной почте предупреждения для операторов или результаты выполнения заданий). Если этот флажок установлен, в вашем распоряжении появляются еще две возможности:

  -  Mail system (Почтовая система) — возможность выбрать одну из двух систем для взаимодействия с электронной почтой: SQLMail (унаследованная система, ориентированная на MAPI) или Database Mail (другое название — SQLiMail, более современная система, ориентированная на SMTP). Подробнее про работу SQL Server и SQL Server Agent с электронной почтой будет рассказано в разд. 8.2.

При помощи кнопки Test (Проверить) можно проверить работоспособность настроенных параметров для работы с электронной почтой, отправив пробное сообщение;

  -  Save copies of the sent messages in the Sent Items folder (Сохранять копии отправленных сообщений в папке Sent Items) — эта возможность доступна только тогда, когда для отправки сообщений используется протокол MAPI (а значит, используется система SQLMail);

Чтобы параметры, связанные с настройками электронной почты, вступили в силу, необходимо перезапустить службу SQL Server Agent.

- в разделе Pager e-mails (Сообщения на пейджер) определяются параметры тех сообщений, которые будут отправляться на пейджер (или на сотовый телефон как сообщения SMS — в зависимости от настроек соответствующего шлюза):

  -  To line, CC line, Subject — возможность определить префиксы и суффиксы для строк Кому, Копия и Тема сообщения соответственно;

  -  Include body of e-mail in notification message (Включить тело письма в уведомляющее сообщение) — если этот флажок установлен, то на пейджер или сотовый телефон будут отправляться уведомления (о перехваченной ошибке или результатах выполнения задания) целиком. Эти сообщения могут быть достаточно большими, поэтому с этим параметром нужно быть осторожнее. Если этот флажок снят, то на пейджер или телефон придет краткое уведомление без подробной информации;

  -  Fail-safe operator — в соответствии с учебными курсами Microsoft, это должно переводиться как "резервный оператор" или "оператор последней надежды". Однако слушатели на курсах придумали более меткое название — "Кто будет крайним". Смысл этого параметра очень прост: для каждого оператора можно указать рабочие часы. Если получилось так, что событие произошло в тот момент, когда все операторы согласно расписанию отдыхают, сообщение будет отправлено "оператору последней надежды" (вне зависимости от расписания его работы). Вы можете указать соответствующий объект оператора и выбрать способ его уведомления: при помощи электронной почты, пейджера или сетевого сообщения;

  -  Replace tokens for all job responses to alerts (Заменять маркеры для всех заданий, которые запускаются в ответ на оповещения) — этот новый параметр определяет, можно ли будет использовать специальные подстановочные символы (например, для имени базы данных) в параметрах заданий, которые автоматически запускаются при срабатывании предупреждений. Подробнее об этом будет рассказано в разд. 8.1.7.

На вкладке Job System (Система заданий) вы можете определить общие параметры для выполнения заданий SQL Server Agent:

- Shutdown time-out interval (in seconds) (Время ожидания при отключении (в секундах)) — если вы дали команду на остановку службы SQL Server Agent, а в это время выполняется задание, то SQL Server Agent даст на его завершение столько секунд, сколько указано в этом параметре (по умолчанию задано 15 секунд). По истечении этого времени работа задания будет прекращена принудительно;

- Job step proxy account (Учетная запись прокси для этапов заданий) — этот параметр позволяет определить учетную запись Windows, от имени которой в ходе выполнения заданий будут выполняться различные действия в операционной системе. По умолчанию SQL Server Agent выполняет эти действия от имени учетной записи, под которой он работает. Обратите внимание, что этот параметр будет доступен только для служб SQL Server Agent, которые входят в состав SQL Server 7.0 и 2000 (если вы решили администрировать их из Management Studio). Для SQL Server 2005 учетные записи прокси настраиваются из контейнера SQL Server Agent | Proxies.

На вкладке Connection (Подключение) настраиваются параметры подключения службы SQL Server Agent к SQL Server:

- Alias local host server (Псевдоним для локального сервера) — псевдоним для экземпляра SQL Server (он обязательно должен быть расположен на том же компьютере), к которому будет подключаться SQL Server Agent. Подробно про псевдонимы рассказывалось в разд. 3.3.4. Этот параметр нужно заполнять только в том случае, если для "нормального имени" SQL Server на вашем компьютере уже существует какой-то другой псевдоним, перенаправляющий запросы к нему на другой сервер;

- SQL Server connection (Подключение к SQL Server) — параметр определяет учетную запись, которая будет использоваться службой SQL Server Agent для подключения к SQL Server. Как уже говорилось, очень рекомендуется использовать для работы служб SQL Server и SQL Server Agent одну и ту же учетную запись. Тогда здесь проще всего оставить аутентификацию Windows (которая выбирается по умолчанию). Если SQL Server и SQL Server Agent работают под разными учетными записями или вам нужно подключаться (для целей обеспечения обратной совместимости) от имени логина SQL Server, то в этом параметре вы можете определить соответствующую учетную запись Windows или логин SQL Server Agent.

На вкладке History (История) определяются параметры хранения истории выполнения заданий в журналах SQL Server Agent:

- Limit size of job history log (Ограничить размер журнала истории выполнения заданий) — если этот флажок снять, то старая информация о выполнении заданий не будет автоматически удаляться из журналов событий SQL Server Agent. Вам потребуется удалять ее вручную. Если же этот флажок установлен (по умолчанию), то можно настроить два дополнительных параметра:

  -  Maximum job history log size (in rows) (Максимальное количество записей для истории выполнения заданий (в строках));

  -  Maximum job history rows per job (Максимальное количество записей для одного задания);

- Automatically remove agent history (Автоматически удалять историю агента) — этот параметр позволяет определить, через какое время записи о истории выполнения заданий будут удаляться автоматически.
