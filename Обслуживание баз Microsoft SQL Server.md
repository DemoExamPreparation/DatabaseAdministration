#  Обслуживание баз Microsoft SQL Server

Рекомендуемые операции обслуживания СУБД MS SQL Server:

- Регулярное резервное копирование баз данных
- Обновление статистики
- Очистка процедурного КЭШа
- Реорганизация индекса
- Перестроение индекса

## Создание плана обслуживания
Все перечисленные выше операции возможно автоматизировать при использовании 
Плана обслуживания в Microsoft SQL Server.

Для начала необходимо подключиться к серверу используя
Microsoft SQL Server Management Studio; 
перейти во вкладку 
_«Управление»_ - _«Планы обслуживания»_ - ПКМ – _«Создать план обслуживания…»_ 
и задать имя плана.

![image](https://user-images.githubusercontent.com/45891293/162903057-49cad1bb-e43e-49f9-8537-5991d5d5a0f6.png)

При создании _Плана обслуживания_ автоматически создаётся _Вложенный план_, 
для которого необходимо создать _«Расписание задания»_ через соответствующую кнопку 
возле таблицы _Расписание_.

![image](https://user-images.githubusercontent.com/45891293/162903127-1b88335f-d274-4f91-9536-028ee020e3b6.png)

Теперь в наш план необходимо добавить непосредственно сами задачи по обслуживанию. 
Для этого используем _«Панель элементов»_ (слева от Обозревателя объектов) 
и добавляем нашу первую задачу _«Проверка целостности базы данных»_.

![image](https://user-images.githubusercontent.com/45891293/162903225-dbecaa95-2c02-4aca-99c3-64eab7aaa3b7.png)

![image](https://user-images.githubusercontent.com/45891293/162903251-cadfc4a8-4dcd-4760-87bc-e6457262837d.png)

В задаче _«Проверка целостности базы данных»_ выберем необходимые для обслуживания базы: 
ПКМ по объекту данной задачи – _«Изменить»_, 
в открывшемся окне из списка _«Базы данных»_ выбираем необходимые нам базы 
(все кроме системных или конкретные).

![image](https://user-images.githubusercontent.com/45891293/162903376-d1d91ca5-1141-4564-b190-6cdc238c94ff.png)

Последующие задание необходимо выбирать исходя из нагрузки и времени выполнения регламентного задания: 
_«Перестроение индекса»_ или _«Реорганизация индекса»_.

- _«Перестроение индекса»_ - включает полное перестроение индексов таблиц базы данных, 
однако в версии MS SQL Server Standard происходит отключение всех клиентов от базы 
на время выполнения операции.

- _«Реорганизация индекса»_ - исправление уже имеющихся индексов, 
не требует отключение клиентов от базы.

_«Реорганизацию индекса»_ имеет делать смысл каждый день. 
В то время как полное _«Перестроение индекса»_ лишь раз в неделю.

Добавляем необходимую нам задачу через 
_«Панель элементов»_ и выбираем необходимые для этой задачи базы.

Далее нам необходимо установить между ними связь: 
выбираем нашу первую задачу _«Проверка целостности базы данных»_ и кликнув (ЛКМ) 
на зеленую стрелку вниз (под объектом) протянем её до объекта нашей следующей задачи.

![image](https://user-images.githubusercontent.com/45891293/162903690-79a48a21-700c-47be-9f82-b129ad1356f3.png)

Открыв _«Редактор управления очередностью» _
(2х ЛКМ по появившейся линии связи) мы можем задавать значение выполнения:

- Успешное выполнение (зеленая линия) – 
последующие задание будет выполняться только в случае успешного выполнения предыдущего.

- Ошибка (красная линия) – 
последующие задание будет выполняться только в случае ошибки выполнения предыдущего задания.

- Завершение (темно-синяя линия) –
последующие задание будет выполняться после предыдущего независимо от результатов выполнения предыдущего.

В данном случае, после успешного выполнения задачи 
_«Проверка целостности базы данных»_ начнётся выполнение задачи 
_«Реорганизация индекса»_, если проверка выявила повреждение базы данных, 
то последующие задачи обслуживания выполнятся не будут.

![image](https://user-images.githubusercontent.com/45891293/162903841-1b124cac-a8fa-4b6b-b6f4-4268d2e92e33.png)

После _«Реорганизации индекса»_ или _«Перестроения индекса»_ 
рекомендуется выполнять _«Обновление статистик»_. 
Добавим соответствующую задачу в _«Панели элементов»_, так же, 
как и в предыдущий раз не забываем выбрать базы для выполнения задачи и установить связь 
с предыдущей задачей на _«Завершение»_ после выполнения предыдущей.

![image](https://user-images.githubusercontent.com/45891293/162903962-eaa4e514-3e35-46b8-91cb-6eaeab325ee7.png)

Далее добавим задачу по _«Очистке процедурного КЭШа»_, 
однако такая задача отсутствует в «Панели элементов», 
поэтому мы добавляем задачу _«Выполнение инструкции T-SQL»_.

Изменим объект_ «Выполнение инструкции T-SQL»_ (2х ЛКМ) 
и в появившемся окне в поле _«Инструкция T-SQL»_ пропишем:
```
dbcc freeproccache
```
После чего не забываем создать связь для вновь добавленной задачи.

![image](https://user-images.githubusercontent.com/45891293/162904161-50ee0cca-4925-49cd-a3af-56d13e5568d2.png)

Теперь перейдём непосредственно к созданию резервной копии базы, добавляем соответствующий элемент на «Панели элементов». Открываем параметры задачи (2х ЛКМ по объекту).

На вкладке _«Общее»_ мы можем выбирать необходимый нам тип резервной копии (Полное, Разностное, Журнал транзакций), базы и компонент резервного копирования (базу данных целиком или отдельные её компоненты).

На вкладке _«Целевой объект»_ есть возможность разбить резервную копию на несколько файлов, создавать файл резервной копии и каталоги для каждой базы отдельно, а также указывать путь хранения резервной копии.

На вкладке _«Параметры»_ рекомендуется указать параметр «Сжимать резервные копии» для уменьшения размера бэкапа и _«Проверку целостности резервной копии»_, так же там можно указать срок действия резервного набора и шифрование.

![image](https://user-images.githubusercontent.com/45891293/162904263-c51bea71-f501-45cb-950b-e1deec450670.png)

Со временем регулярное создание бэкапов приведет к заполнению дискового пространства, поэтому рекомендуется удалять устаревшие и неактуальные архивы, для этого мы добавим задачу _«Очистка после обслуживания»_.

В ней мы указываем путь до наших бэкапов, расширение файла (в нашем случае стандартное *.bak) и временной промежуток по прошествии которого удалятся старые файлы бэкапов.

Помимо самих бэкапов баз, место на жестком диске могут занимать журналы регламентных заданий MS SQL Server, их мы тоже будем периодически очищать, добавив задачу _«Очистка журнала»_.

![image](https://user-images.githubusercontent.com/45891293/162904297-24bd6582-fb03-40f9-895b-1424d1bd9c17.png)

![image](https://user-images.githubusercontent.com/45891293/162904323-e2fac8e5-a8d0-4ffb-83ac-53df72f8cd57.png)

В итоге наш _«План обслуживания»_ будет выглядеть следующим образом:

![image](https://user-images.githubusercontent.com/45891293/162904344-5c91120a-ecd4-424c-982e-779cd6f2070a.png)

Данные задачи рекомендуется выполнять не реже 1 раза в сутки в часы минимальной загруженности сервера. Мы так же можем добавлять в _«Планы обслуживания»_ дополнительные _«Вложенные планы»_, которые создаются и настраиваются аналогичным образом, если, например, есть необходимость делать бэкапы чаще 1 раза за сутки или раз в неделю проводить полное _«Перестроение индекса»_ вместо регулярной реорганизации.

Просмотреть журнал выполнения «Плана обслуживания» на наличие ошибок возможно через «Просмотр журнала»: «Обозреватель объектов» - «Управление» - «Планы обслуживания» - ПКМ (по плану обслуживания) – «Просмотр журнала».

Отдельно стоит обратить внимание на запуск в системе службы «Агент SQL Server». Данная служба отвечает за выполнение «Планов обслуживания», соответственно, в свойствах службы необходимо проверить чтобы стоял «Тип запуска: Автоматический».

![image](https://user-images.githubusercontent.com/45891293/162904447-a73bf13f-2050-4931-9d48-4a921123d43f.png)
